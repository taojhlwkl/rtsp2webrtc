<!DOCTYPE html>
<html>
<head>
  <title></title>
</head>
<body>
    <script src="./jquery.min.js"></script>
    <div id="remoteVideos"></div>
    <br />
    Browser base64 Session Description
    <textarea id="localSessionDescription" readonly="true"></textarea> <br />
    Golang base64 Session Description:
    <textarea id="remoteSessionDescription"></textarea>
    <br/>

    <button onclick="window.startSession()"> Start Session </button>
    <script>
        var rtsplist = [
            'rtsp://admin:123456@171.25.232.42:1554/mpeg4cif',
            'rtsp://admin:123456@171.25.232.42:1554/mpeg4cif1',
            'rtsp://admin:123456@171.25.232.42:1554/mpeg4cif2'
        ];

        var rtsplistStr = rtsplist.join(',');

        var newRtcPeerConnection = new RTCPeerConnection();
        
        rtcPeerCreateOffer(newRtcPeerConnection, rtsplistStr);

        /* eslint-env browser */
        // let pc = new RTCPeerConnection({
        //   iceServers: [
        //     {
        //       urls: 'stun:stun.l.google.com:19302'
        //     }
        //   ]
        // })
        var log = function(msg){
            console.log(msg);
        }

        function rtcPeerCreateOffer(pc, rtspUrl) {
            pc.ontrack = function (event) {
                var el = document.createElement(event.track.kind)
                el.srcObject = event.streams[0]
                el.autoplay = true
                el.controls = true
                document.getElementById('remoteVideos').appendChild(el)
            }

            pc.oniceconnectionstatechange = function(e) {
                log(pc.iceConnectionState);
            }

            pc.onicecandidate = event => {
                if (event.candidate === null) {
                    document.getElementById('localSessionDescription').value = btoa(pc.localDescription.sdp)
                    $.post("/recive", 
                    {
                        data:btoa(pc.localDescription.sdp), rtspUrl: rtspUrl
                    },
                    function(data){
                        document.getElementById('remoteSessionDescription').value = data
                        window.startSession(pc)
                    });
                }
            }

            pc.createOffer({offerToReceiveVideo: true, offerToReceiveAudio: true})
            .then(function(d) {
                pc.setLocalDescription(d)}
            ).catch(log)
        }

        window.startSession = function(pc) {
            let sd = document.getElementById('remoteSessionDescription').value
            if (sd === '') {
                return alert('Session Description must not be empty')
            }

            try {
                pc.setRemoteDescription(new RTCSessionDescription({type: 'answer', sdp: atob(sd)}))
            } catch (e) {
                alert(e)
            }
        }
    </script>
</body>
</html>
